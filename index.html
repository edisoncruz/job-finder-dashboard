<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sara's Job Finder ‚Äî Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root {
    --bg: #f5f5f5; --card: #ffffff; --text: #1a1a1a; --muted: #666;
    --accent: #2563eb; --border: #e5e5e5;
    --green-bg: #dcfce7; --green-text: #166534;
    --blue-bg: #dbeafe; --blue-text: #1e40af;
    --amber-bg: #fef3c7; --amber-text: #92400e;
    --purple-bg: #fae8ff; --purple-text: #86198f;
    --red-bg: #fef2f2; --red-text: #991b1b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-text-size-adjust: 100%; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Header */
  .header { background: #1a1a1a; color: #fff; padding: 16px; }
  .header h1 { font-size: 20px; font-weight: 700; }
  .header p { font-size: 12px; color: #a0a0a0; margin-top: 2px; }

  /* Controls */
  .controls { padding: 12px 16px; background: #fff; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 8px; }
  .controls select, .controls input { font-size: 14px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; -webkit-appearance: none; appearance: none; }
  .controls select { padding-right: 28px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; }
  .controls label { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
  .control-group { display: flex; flex-direction: column; gap: 3px; flex: 1; min-width: 110px; }
  .control-group input { width: 100%; }

  /* Stats bar */
  .stats-bar { padding: 10px 16px; background: #fafafa; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; }
  .stats-bar span { font-weight: 600; color: var(--text); }

  /* Container */
  .container { max-width: 860px; margin: 0 auto; padding-bottom: 40px; }

  /* Job card */
  .job-card { background: var(--card); margin: 10px 12px; border-radius: 10px; border: 1px solid var(--border); padding: 16px; transition: box-shadow 0.15s; }
  .job-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .job-card.inactive { opacity: 0.5; }

  .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
  .card-top-left { flex: 1; min-width: 0; }

  .badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 6px; }
  .badge { display: inline-block; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 7px; border-radius: 3px; white-space: nowrap; }
  .badge-strong { background: var(--green-bg); color: var(--green-text); }
  .badge-good { background: var(--blue-bg); color: var(--blue-text); }
  .badge-stretch { background: var(--amber-bg); color: var(--amber-text); }
  .badge-dream { background: var(--purple-bg); color: var(--purple-text); }
  .badge-inactive { background: #f3f4f6; color: #6b7280; }

  .score-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 800; flex-shrink: 0; }
  .score-high { background: var(--green-bg); color: var(--green-text); }
  .score-mid { background: var(--blue-bg); color: var(--blue-text); }
  .score-low { background: var(--amber-bg); color: var(--amber-text); }

  .job-title { font-size: 16px; font-weight: 700; line-height: 1.3; }
  .job-company { font-size: 14px; color: var(--accent); font-weight: 600; margin-top: 1px; }

  .job-meta { font-size: 12px; color: var(--muted); margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 4px 14px; }

  /* Why it fits ‚Äî distinct sections */
  .why-fits { margin: 12px 0; background: #f8fafc; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
  .why-section { padding: 10px 14px; border-bottom: 1px solid #e2e8f0; }
  .why-section:last-child { border-bottom: none; }
  .why-label { font-weight: 700; color: #64748b; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 3px; }
  .why-text { font-size: 13px; color: #334155; line-height: 1.4; }
  .why-company { background: #f0f9ff; }
  .why-company .why-text { color: #0c4a6e; }
  .why-strength { background: #f0fdf4; }
  .why-strength .why-text { color: #166534; }
  .why-concern { background: #fffbeb; }
  .why-concern .why-text { color: #92400e; }

  .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  .btn { display: inline-flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; padding: 10px 18px; border-radius: 8px; cursor: pointer; border: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  .btn-apply { background: var(--accent); color: #fff; flex: 1; min-width: 0; }
  .btn-up { background: #f0fdf4; color: var(--green-text); border: 1px solid #bbf7d0; }
  .btn-down { background: var(--red-bg); color: var(--red-text); border: 1px solid #fecaca; }
  .btn:disabled { opacity: 0.5; cursor: default; }
  .btn:active { transform: scale(0.97); }

  /* Feedback reason */
  .feedback-form { display: none; margin-top: 10px; padding: 12px; background: #fafafa; border-radius: 8px; border: 1px solid var(--border); }
  .feedback-form.show { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .feedback-form select { font-size: 13px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; flex: 1; min-width: 150px; }
  .feedback-form button { font-size: 13px; padding: 8px 16px; }

  .empty-state { text-align: center; padding: 60px 24px; color: var(--muted); }
  .empty-state h2 { font-size: 18px; color: var(--text); margin-bottom: 8px; }
  .loading { text-align: center; padding: 48px; font-size: 15px; color: var(--muted); }

  /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    .header { padding: 14px 12px; }
    .header h1 { font-size: 18px; }
    .controls { padding: 10px 12px; gap: 6px; }
    .control-group { min-width: 90px; }
    .job-card { margin: 8px 8px; padding: 14px; }
    .job-title { font-size: 15px; }
    .score-circle { width: 38px; height: 38px; font-size: 13px; }
    .actions { flex-direction: column; }
    .actions .btn { width: 100%; }
    .feedback-form.show { flex-direction: column; }
    .feedback-form select, .feedback-form button { width: 100%; }
  }

  @media (min-width: 601px) {
    .header { padding: 20px 24px; }
    .header h1 { font-size: 22px; }
    .controls { padding: 14px 24px; }
    .stats-bar { padding: 12px 24px; }
    .job-card { margin: 12px 16px; padding: 20px; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Sara's Job Finder</h1>
  <p id="header-subtitle">Dashboard</p>
</div>

<div id="app" style="display:none;">
  <div class="controls">
    <div class="control-group">
      <label>Sort</label>
      <select id="sort-select">
        <option value="score">Score (High ‚Üí Low)</option>
        <option value="date">Date (Newest)</option>
        <option value="company">Company (A-Z)</option>
      </select>
    </div>
    <div class="control-group">
      <label>Tier</label>
      <select id="tier-filter">
        <option value="all">All Tiers</option>
        <option value="strong">Strong (8+)</option>
        <option value="good">Good (6-8)</option>
        <option value="stretch">Stretch (&lt;6)</option>
      </select>
    </div>
    <div class="control-group">
      <label>Location</label>
      <select id="location-filter">
        <option value="all">All</option>
        <option value="remote">Remote</option>
        <option value="fl">South Florida</option>
      </select>
    </div>
    <div class="control-group">
      <label>Status</label>
      <select id="status-filter">
        <option value="active">Active</option>
        <option value="all">All</option>
      </select>
    </div>
    <div class="control-group">
      <label>Search</label>
      <input id="search-input" type="text" placeholder="Company or title...">
    </div>
  </div>

  <div class="stats-bar" id="stats-bar"></div>

  <div class="container" id="jobs-container">
    <div class="loading">Loading jobs...</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://mijyjyttryjcwglqjpfs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1panlqeXR0cnlqY3dnbHFqcGZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNDMzNDgsImV4cCI6MjA4NzgxOTM0OH0.kQYQFbbeckz_IVzbLSbyNosPAkot-ksqSJk80VR-i3I';
let sbClient = null;
let allJobs = [];
const DREAM_COMPANIES = new Set(['eon', 'daydream', 'beni']);

function init() {
  sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  document.getElementById('app').style.display = 'block';
  loadJobs();
  ['sort-select','tier-filter','location-filter','status-filter'].forEach(id =>
    document.getElementById(id).addEventListener('change', renderJobs));
  document.getElementById('search-input').addEventListener('input', renderJobs);
}

async function loadJobs() {
  try {
    const { data, error } = await sbClient.from('jobs').select('*')
      .not('score', 'is', null).order('score', { ascending: false });
    if (error) throw error;
    allJobs = data || [];
    renderJobs();
  } catch (e) {
    document.getElementById('jobs-container').innerHTML =
      `<div class="empty-state"><h2>Connection Error</h2><p>${e.message}</p></div>`;
  }
}

function getFilteredJobs() {
  const tier = document.getElementById('tier-filter').value;
  const loc = document.getElementById('location-filter').value;
  const status = document.getElementById('status-filter').value;
  const search = document.getElementById('search-input').value.toLowerCase().trim();
  const sort = document.getElementById('sort-select').value;

  let jobs = [...allJobs];
  if (status === 'active') jobs = jobs.filter(j => j.is_active);
  if (tier === 'strong') jobs = jobs.filter(j => j.score >= 8);
  else if (tier === 'good') jobs = jobs.filter(j => j.score >= 6 && j.score < 8);
  else if (tier === 'stretch') jobs = jobs.filter(j => j.score < 6);
  if (loc === 'remote') jobs = jobs.filter(j => /remote|anywhere|distributed|work from home/i.test(j.location || ''));
  else if (loc === 'fl') jobs = jobs.filter(j => /miami|fort lauderdale|boca|hollywood|south florida|broward|dade|palm beach|, fl/i.test(j.location || ''));
  if (search) jobs = jobs.filter(j => (j.title||'').toLowerCase().includes(search) || (j.company||'').toLowerCase().includes(search));
  if (sort === 'score') jobs.sort((a, b) => (b.score||0) - (a.score||0));
  else if (sort === 'date') jobs.sort((a, b) => (b.date_posted||'').localeCompare(a.date_posted||''));
  else if (sort === 'company') jobs.sort((a, b) => (a.company||'').localeCompare(b.company||''));
  return jobs;
}

function renderJobs() {
  const jobs = getFilteredJobs();
  const container = document.getElementById('jobs-container');
  const active = allJobs.filter(j => j.is_active);
  document.getElementById('stats-bar').innerHTML =
    `Showing <span>${jobs.length}</span> of <span>${allJobs.length}</span> ¬∑ ` +
    `<span style="color:var(--green-text)">${active.filter(j=>j.score>=8).length}</span> strong ¬∑ ` +
    `<span style="color:var(--blue-text)">${active.filter(j=>j.score>=6&&j.score<8).length}</span> good ¬∑ ` +
    `<span style="color:var(--amber-text)">${active.filter(j=>j.score<6).length}</span> stretch ¬∑ ` +
    `<span>${allJobs.filter(j=>j.app_status==='applied').length}</span> applied`;

  if (!jobs.length) {
    container.innerHTML = '<div class="empty-state"><h2>No jobs match your filters</h2><p>Try adjusting the filters above.</p></div>';
    return;
  }
  container.innerHTML = jobs.map(renderCard).join('');
}

function renderCard(job) {
  const isDream = DREAM_COMPANIES.has((job.company||'').toLowerCase());
  const score = job.score || 0;
  const scoreClass = score >= 8 ? 'score-high' : score >= 6 ? 'score-mid' : 'score-low';
  const tierBadge = score >= 8 ? '<span class="badge badge-strong">Strong Match</span>'
    : score >= 6 ? '<span class="badge badge-good">Worth a Look</span>'
    : '<span class="badge badge-stretch">Stretch</span>';

  // Why it fits
  let whyHtml = '';
  const why = typeof job.why_it_fits === 'string' ? tryParse(job.why_it_fits) : (job.why_it_fits || {});
  if (why && Object.keys(why).length) {
    let s = '';
    if (why.company_snapshot) s += `<div class="why-section why-company"><span class="why-label">üè¢ About the Company</span><span class="why-text">${esc(why.company_snapshot)}</span></div>`;
    if (why.role_match) s += `<div class="why-section"><span class="why-label">üéØ Role Match</span><span class="why-text">${esc(why.role_match)}</span></div>`;
    if (why.experience_connection) s += `<div class="why-section"><span class="why-label">üíº Your Experience</span><span class="why-text">${esc(why.experience_connection)}</span></div>`;
    if (why.industry_relevance) s += `<div class="why-section"><span class="why-label">üè∑Ô∏è Industry Fit</span><span class="why-text">${esc(why.industry_relevance)}</span></div>`;
    if (why.strengths) s += `<div class="why-section why-strength"><span class="why-label">‚úÖ Strengths</span><span class="why-text">${esc(why.strengths)}</span></div>`;
    if (why.concerns) s += `<div class="why-section why-concern"><span class="why-label">‚ö†Ô∏è Heads Up</span><span class="why-text">${esc(why.concerns)}</span></div>`;
    if (why.summary && !why.role_match) s += `<div class="why-section"><span class="why-label">Summary</span><span class="why-text">${esc(why.summary)}</span></div>`;
    if (s) whyHtml = `<div class="why-fits">${s}</div>`;
  }

  const hasFb = job.feedback && job.feedback !== '';
  const fbLabel = job.feedback === 'relevant' ? '‚úÖ Good match'
    : job.feedback === 'not_relevant' ? '‚ùå Not for me'
    : job.feedback === 'applied' ? 'üöÄ Applied' : '';

  return `
  <div class="job-card${job.is_active ? '' : ' inactive'}" id="card-${job.id}">
    <div class="card-top">
      <div class="card-top-left">
        <div class="badges">
          ${tierBadge}
          ${isDream ? '<span class="badge badge-dream">Dream Company</span>' : ''}
          ${!job.is_active ? '<span class="badge badge-inactive">Inactive</span>' : ''}
        </div>
        <div class="job-title">${esc(job.title)}</div>
        <div class="job-company">${esc(job.company)}</div>
      </div>
      <div class="score-circle ${scoreClass}">${score.toFixed(1)}</div>
    </div>
    <div class="job-meta">
      ${job.location ? `<span>üìç ${esc(job.location)}</span>` : ''}
      ${job.salary_info ? `<span>üí∞ ${esc(job.salary_info)}</span>` : ''}
      ${job.date_posted ? `<span>üìÖ ${esc(job.date_posted)}</span>` : ''}
      <span>${esc(job.source || '')}</span>
    </div>
    ${whyHtml}
    <div class="actions">
      ${job.url ? `<a href="${esc(job.url)}" target="_blank" class="btn btn-apply" onclick="markApplied('${job.id}',this)">Apply ‚Üí</a>` : ''}
      ${hasFb
        ? `<span class="btn" style="background:#f9fafb;color:var(--muted);cursor:default">${fbLabel}</span>`
        : `<button class="btn btn-up" onclick="submitFeedback('${job.id}','relevant',this)">üëç Good match</button>
           <button class="btn btn-down" onclick="showFeedbackForm('${job.id}')">üëé Not for me</button>`}
    </div>
    <div class="feedback-form" id="fb-form-${job.id}">
      <select id="fb-reason-${job.id}">
        <option value="">Why isn't this a fit?</option>
        <option value="wrong_role">Wrong role / function</option>
        <option value="wrong_location">Wrong location</option>
        <option value="wrong_industry">Wrong industry</option>
        <option value="too_junior">Too junior</option>
        <option value="too_senior">Too senior</option>
        <option value="low_comp">Compensation too low</option>
        <option value="other">Other</option>
      </select>
      <button class="btn btn-down" onclick="submitNotRelevant('${job.id}')">Submit</button>
    </div>
  </div>`;
}

function esc(s) { if (!s) return ''; const d=document.createElement('div'); d.textContent=String(s); return d.innerHTML; }
function tryParse(s) { try { return typeof s==='string' ? JSON.parse(s) : s; } catch { return {}; } }

function showFeedbackForm(id) { document.getElementById(`fb-form-${id}`).classList.toggle('show'); }

async function submitFeedback(jobId, vote, btn) {
  btn.disabled = true; btn.textContent = '...';
  try {
    const { error } = await sbClient.from('feedback').insert({ job_id: jobId, vote, reason: '', created_at: new Date().toISOString() });
    if (error) throw error;
    const job = allJobs.find(j => j.id === jobId);
    if (job) job.feedback = vote;
    renderJobs();
  } catch (e) { alert('Failed: ' + e.message); btn.disabled = false; btn.textContent = vote === 'relevant' ? 'üëç Good match' : 'üëé Not for me'; }
}

async function submitNotRelevant(jobId) {
  const reason = document.getElementById(`fb-reason-${jobId}`).value;
  try {
    const { error } = await sbClient.from('feedback').insert({ job_id: jobId, vote: 'not_relevant', reason, created_at: new Date().toISOString() });
    if (error) throw error;
    const job = allJobs.find(j => j.id === jobId);
    if (job) { job.feedback = 'not_relevant'; job.feedback_reason = reason; }
    renderJobs();
  } catch (e) { alert('Failed: ' + e.message); }
}

async function markApplied(jobId) {
  try {
    await sbClient.from('feedback').insert({ job_id: jobId, vote: 'applied', reason: '', created_at: new Date().toISOString() });
    const job = allJobs.find(j => j.id === jobId);
    if (job) { job.feedback = 'applied'; job.app_status = 'applied'; }
    setTimeout(renderJobs, 500);
  } catch (e) { console.warn('Failed to mark applied:', e); }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
